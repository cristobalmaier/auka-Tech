<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../parciales/head.html') %>
    <link rel="stylesheet" href="logeo.css">
    
    <!-- ICONOS (Font Awesome) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- ANIMACIONES (Animate.css) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="contenedor-vh fondo-partido">
        <div class="espera-contenedor">
            <h1>Tu solicitud ha sido enviada</h1>
            <p id="status-message">Cuando aprobemos tu solicitud, podrás acceder a tu cuenta.</p>
            <div class="botones">
                <a href="/" id="back-button">Volver a la página principal</a>
            </div>
        </div>
    </div>

    <!-- Notificación estilo directivos -->
    <div
      id="notificacion"
      class="alerta animate__animated animate__fadeInRight"
      style="display: none"
    >
      <i id="notificacionIcono"></i>
      <span id="notificacionMensaje"></span>
    </div>

    <style>
        :root {
            --color-alerta-exito-fondo: #DCFCE7;
            --color-alerta-exito-borde: #86EFAC;
            --color-alerta-exito-texto: #1C8B45;

            --color-alerta-error-fondo: #FEE2E2;
            --color-alerta-error-borde: #FCA5A5;
            --color-alerta-error-texto: #EF4444;

            --color-alerta-info-fondo: #DBEAFE;
            --color-alerta-info-borde: #93C5FD;
            --color-alerta-info-texto: #3070D7;
        }

        .alerta {
            position: fixed;
            right: 70px;
            top: 60px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 350px;
        }
          
        .alerta i {
            font-size: 36px;
        }
          
        .alerta span {
            font-size: 15px;
            font-weight: 600;
        }
         
        .alerta-exito {
            background-color: var(--color-alerta-exito-fondo);
            border: 1px solid var(--color-alerta-exito-borde);
            color: var(--color-alerta-exito-texto);
            border-radius: 10px;
        } 

        .alerta-error {
            background-color: var(--color-alerta-error-fondo);
            border: 1px solid var(--color-alerta-error-borde);
            color: var(--color-alerta-error-texto);
            border-radius: 10px;
        }

        .alerta-info {
            background-color: var(--color-alerta-info-fondo);
            border: 1px solid var(--color-alerta-info-borde);
            color: var(--color-alerta-info-texto);
            border-radius: 10px;
        }
    </style>

    <script type="module">
        // Función para mostrar notificación
        function mostrarNotificacion(tipo, mensaje) {
            const notificacion = document.getElementById('notificacion');
            const notificacionIcono = document.getElementById('notificacionIcono');
            const notificacionMensaje = document.getElementById('notificacionMensaje');

            notificacion.classList.remove('alerta-exito', 'alerta-error');
            notificacionIcono.className = '';

            if (tipo === 'exito') {
                notificacion.classList.add('alerta-exito');
                notificacionIcono.classList.add('fas', 'fa-check-circle');
            } else {
                notificacion.classList.add('alerta-error');
                notificacionIcono.classList.add('fas', 'fa-times-circle');
            }

            notificacionMensaje.textContent = mensaje;
            notificacion.style.display = 'flex';

            setTimeout(() => {
                notificacion.style.display = 'none';
            }, 3000);
        }
        
        // Get the user's email from template variables
        const userEmail = '<%= email %>';
        
        if (userEmail) {
            console.log('Esperando verificación para:', userEmail);
            
            // Connect to Socket.IO
            const socket = io();
            
            // Debug: Log socket connection
            socket.on('connect', () => {
                console.log('Conectado al servidor WebSocket con ID:', socket.id);
            });
            
            socket.on('connect_error', (error) => {
                console.error('Error de conexión WebSocket:', error);
                // Mostrar alerta de error de conexión
                mostrarNotificacion('error', 'Error de conexión. Recargando la página...');
                setTimeout(() => location.reload(), 2000);
            });
            
            // Listen for account verification
            socket.on('account_verified', (data) => {
                console.log('Evento account_verified recibido:', data);
                
                if (data.email === userEmail) {
                    console.log('Correo verificado coincide con el usuario actual');
                    
                    // Ocultar elementos de la interfaz
                    document.getElementById('status-message').style.display = 'none';
                    document.getElementById('back-button').style.display = 'none';
                    
                    // Mostrar notificación de éxito
                    mostrarNotificacion('exito', '¡Tu cuenta ha sido verificada! Redirigiendo al inicio de sesión...');
                    console.log('Notificación mostrada');
                    
                    // Redirigir después de 3 segundos (mismo tiempo que la animación)
                    setTimeout(() => {
                        window.location.href = '/login?verified=true';
                    }, 3000);
                } else {
                    console.log('Correo verificado no coincide:', data.email, '!=', userEmail);
                }
            });
            
            // Debug: Log any errors
            socket.on('error', (error) => {
                console.error('Error en el socket:', error);
                mostrarNotificacion('error', 'Error en la conexión. Recargando...');
                setTimeout(() => location.reload(), 2000);
            });
        } else {
            console.error('No se encontró el correo electrónico del usuario');
        }
    </script>
</body>
</html>