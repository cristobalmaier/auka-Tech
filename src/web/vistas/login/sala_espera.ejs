<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../parciales/head.html') %>
    <link rel="stylesheet" href="logeo.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="contenedor-vh fondo-partido">
        <div class="espera-contenedor">
            <h1>Tu solicitud ha sido enviada</h1>
            <p id="status-message">Cuando aprobemos tu solicitud, podrás acceder a tu cuenta.</p>
            <div class="botones">
                <a href="/" id="back-button">Volver a la página principal</a>
            </div>
        </div>
    </div>

    <!-- Notificación estilo toast -->
    <div id="notificacion" style="display: none;">
        <i id="notificacionIcono"></i>
        <span id="notificacionMensaje"></span>
    </div>

    <style>
        /* Estilos para la notificación */
        #notificacion {
            position: fixed;
            right: 24px;
            top: 24px;
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            color: #fff;
            border-radius: 10px;
            box-shadow: 0 12px 34px rgba(2,6,23,0.12);
            z-index: 1200;
            font-weight: 600;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #notificacion i {
            font-size: 18px;
        }

        #notificacion.alerta-exito {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        #notificacion.alerta-error {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        #notificacion.alerta-info {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>

    <script type="module">
        // Función para mostrar notificaciones
        function mostrarNotificacion(tipo, mensaje) {
            const notificacion = document.getElementById('notificacion');
            const notificacionIcono = document.getElementById('notificacionIcono');
            const notificacionMensaje = document.getElementById('notificacionMensaje');
            
            if (!notificacion || !notificacionIcono || !notificacionMensaje) {
                console.error('Elementos de notificación no encontrados');
                return;
            }
            
            // Resetear clases
            notificacion.className = '';
            notificacionIcono.className = '';
            
            // Configurar según el tipo
            notificacion.classList.add(tipo === 'exito' ? 'alerta-exito' : 
                                    tipo === 'error' ? 'alerta-error' : 'alerta-info');
            
            // Configurar icono
            notificacionIcono.classList.add('fas', 
                tipo === 'exito' ? 'fa-check-circle' : 
                tipo === 'error' ? 'fa-times-circle' : 'fa-info-circle');
            
            // Configurar mensaje
            notificacionMensaje.textContent = mensaje;
            
            // Mostrar con animación
            notificacion.style.display = 'flex';
            notificacion.style.animation = 'slideIn 0.3s ease-out forwards';
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                notificacion.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    notificacion.style.display = 'none';
                }, 300);
            }, 3000);
        }
        
        // Get the user's email from template variables
        const userEmail = '<%= email %>';
        
        if (userEmail) {
            console.log('Esperando verificación para:', userEmail);
            
            // Connect to Socket.IO
            const socket = io();
            
            // Debug: Log socket connection
            socket.on('connect', () => {
                console.log('Conectado al servidor WebSocket con ID:', socket.id);
            });
            
            socket.on('connect_error', (error) => {
                console.error('Error de conexión WebSocket:', error);
                // Mostrar alerta de error de conexión
                mostrarNotificacion('error', 'Error de conexión. Recargando la página...');
                setTimeout(() => location.reload(), 2000);
            });
            
            // Listen for account verification
            socket.on('account_verified', (data) => {
                console.log('Evento account_verified recibido:', data);
                
                if (data.email === userEmail) {
                    console.log('Correo verificado coincide con el usuario actual');
                    
                    // Ocultar elementos de la interfaz
                    document.getElementById('status-message').style.display = 'none';
                    document.getElementById('back-button').style.display = 'none';
                    
                    // Mostrar notificación de éxito
                    mostrarNotificacion('exito', '¡Tu cuenta ha sido verificada! Redirigiendo al inicio de sesión...');
                    console.log('Notificación mostrada');
                    
                    // Redirigir después de 3 segundos (mismo tiempo que la animación)
                    setTimeout(() => {
                        window.location.href = '/login?verified=true';
                    }, 3000);
                } else {
                    console.log('Correo verificado no coincide:', data.email, '!=', userEmail);
                }
            });
            
            // Debug: Log any errors
            socket.on('error', (error) => {
                console.error('Error en el socket:', error);
                mostrarNotificacion('error', 'Error en la conexión. Recargando...');
                setTimeout(() => location.reload(), 2000);
            });
        } else {
            console.error('No se encontró el correo electrónico del usuario');
        }
    </script>
</body>
</html>